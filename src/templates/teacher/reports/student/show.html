{% extends "base.html" %}

{% block content %}
<section class="content-section" >
    <h1>{{ student.username }}'s Overall Report</h1>
    {% if assessment_data %}
        <table>
            <thead>
                <tr>
                    <th>Average Score</th>
                    <th>Class Average Score</th>
                    <th>Total Attempts</th>
                    <th>Passed Attempts</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    {% set avg_scores = [] %}
                    {% set avg_attempts = [] %}
                    {% set class_avg_scores = [] %}
                    {% for assessment in assessment_data %}
                        {% set _ = avg_scores.append(assessment.avg_score) %}
                        {% set _ = avg_attempts.append(assessment.avg_attempts) %}
                        {% set _ = class_avg_scores.append(assessment.class_avg_score) %}
                    {% endfor %}
                    <td>{{ "%.2f" % (avg_scores | sum / avg_scores | length) }}%</td>
                    <td>{{ "%.2f" % (class_avg_scores | sum / class_avg_scores | length) }}%</td>
                    <td>{{ assessment_data | map(attribute='total_attempts') | sum }}</td>
                    <td>{{ assessment_data | map(attribute='total_passed') | sum }}</td>
                </tr>
            </tbody>
        </table>
        <!--<h4>Timeline:</h4>
        <ul>
        {% for assessment_name, avg_score in assessment_avg_scores.items() %}
            <li>{{ assessment_name }}: {{ avg_score }}</li>
        {% endfor %}
        </ul>-->
        <canvas id="timeline"></canvas>
        <script>
            var ctx = document.getElementById('timeline').getContext('2d');
            var chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: [{% for assessment in assessment_data %}"{{ assessment.name }}"{% if not loop.last %},{% endif %}{% endfor %}],
                datasets: [{
                  label: 'Assessment Scores',
                  data: [{% for assessment in assessment_data %}{{assessment.avg_score}}{% if not loop.last %},{% endif %}{% endfor %}],
                  backgroundColor: 'rgba(0, 0, 0, 0)',
                  borderColor: 'blue',
                  borderWidth: 1
                },
                {
                  label: 'Class Average Score',
                  data: [{% for assessment in assessment_data %}{{assessment.class_avg_score}}{% if not loop.last %},{% endif %}{% endfor %}],
                  backgroundColor: 'rgba(0, 0, 0, 0)',
                  borderColor: 'red',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true,
                      min: 0,
                      max: 100,
                      stepSize: 10
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'Percentage'
                    }
                  }]
                }
              }
            });            
        </script>          
    {% else %}
        <p>No assessments found for this student.</p>
    {% endif %}
<form action="{{ url_for('teachers.view_student_assessments', id=student.id) }}" method="get">
    <button type="submit" class="primary-button">View All Assessments</button>
</form>
</section>
{% endblock content %}